name: Test
"on":
  pull_request:
jobs:
  test:
    name: Run test suite
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Check migrations
        run: make check-migrations
      - name: Run pytest
        run: make pytest
      - name: Run bandit
        run: make bandit
  format-checks:
    name: Run devenv format checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run format checks using pre-built devenv image
        id: docker_format
        continue-on-error: true
        run: |
          docker run --rm \
            --user $(id -u):$(id -g) \
            -v ${{ github.workspace }}:/workspace \
            kyokley/mediaviewer-devenv:latest \
            tasks run mv:format
      # Fallback to Nix installation if Docker image doesn't exist or fails
      - name: Fallback - Install Nix (if Docker failed)
        if: steps.docker_format.outcome == 'failure'
        uses: cachix/install-nix-action@v30
      - name: Fallback - Setup Cachix (if Docker failed)
        if: steps.docker_format.outcome == 'failure'
        uses: cachix/cachix-action@v14
        with:
          name: devenv
      - name: Fallback - Install devenv (if Docker failed)
        if: steps.docker_format.outcome == 'failure'
        run: nix profile install nixpkgs#devenv
      - name: Fallback - Run format checks with Nix (if Docker failed)
        if: steps.docker_format.outcome == 'failure'
        run: |
          echo "⚠️ Docker image not available, falling back to Nix installation"
          echo "Consider manually triggering the 'Build Devenv Image' workflow"
          devenv tasks run mv:format
