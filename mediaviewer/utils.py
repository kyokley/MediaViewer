# Based on an example from http://masnun.com/2010/01/01/sending-mail-via-postfix-a-perfect-python-example.html
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.base import MIMEBase
from email.mime.text import MIMEText
from email.utils import formatdate
from email import encoders as Encoders
from datetime import datetime
from binascii import hexlify
from functools import wraps

from django.conf import settings
from django.contrib.auth import get_user_model

import os
import telnetlib  # nosec

from mediaviewer.log import log

SUFFIXES = ("B", "KB", "MB", "GB", "TB", "PB")
COMMASPACE = ", "


def getSomewhatUniqueID(numBytes=4):
    return hexlify(os.urandom(numBytes)).decode("ascii")


def logAccessInfo(func):
    @wraps(func)
    def wrap(*args, **kwargs):
        id = getSomewhatUniqueID()
        request = args and args[0]
        username = None
        if settings.LOG_ACCESS_TIMINGS:
            start = datetime.now()

        if not request:
            log.debug(f"{id}: No request")
        elif request.user and request.user.username:
            username = request.user.username
            log.debug(f"{id}: {username} is accessing {func.__name__}")
        else:
            log.debug(f"{id}: Got request but no user")

        if kwargs:
            log.debug(f"{id}: With kwargs:\n{kwargs}")

        try:
            res = func(*args, **kwargs)
        except Exception as e:
            # Log unhandled exceptions
            log.error(f"{id}: {e}", exc_info=True)
            log.error(f"{id}: Access attempted with following vars...")
            log.error(f"{id}: {locals()}")
            raise

        if settings.LOG_ACCESS_TIMINGS:
            finished = datetime.now()
            log.debug(f"{id}: page started at: {start}")
            log.debug(f"{id}: page finished at: {finished}")
            log.debug(f"{id}: page total took: {start}")

        return res

    return wrap


def humansize(nbytes):
    if nbytes == 0:
        return "0 B"

    i = 0
    while nbytes >= 1024 and i < len(SUFFIXES) - 1:
        nbytes /= 1024.0
        i += 1
    val = ("%.2f" % nbytes).rstrip("0").rstrip(".")
    return f"{val} {SUFFIXES[i]}"


def sendMail(
    to_addr,
    subject,
    text,
    from_addr=settings.EMAIL_FROM_ADDR,
    files=None,
    server=settings.EMAIL_HOST,
    port=settings.EMAIL_PORT,
    use_tls=settings.EMAIL_USE_TLS,
):
    if not isinstance(to_addr, list):
        to_addr = set([to_addr])
    else:
        to_addr = set(to_addr)

    if not files:
        files = []
    if type(files) is not list:
        files = [files]

    msg = MIMEMultipart()
    msg["From"] = from_addr
    msg["To"] = COMMASPACE.join(to_addr)
    msg["Date"] = formatdate(localtime=True)
    msg["Subject"] = subject

    msg.attach(MIMEText(text, "html"))

    for file in files:
        part = MIMEBase("application", "octet-stream")
        part.set_payload(open(file, "rb").read())
        Encoders.encode_base64(part)
        part.add_header(
            "Content-Disposition", f'attachment; filename="{os.path.basename(file)}"'
        )
        msg.attach(part)

    # BCC staff members by adding them to recipient list
    staff = get_user_model().objects.filter(is_staff=True)
    for user in staff:
        if user.email:
            to_addr.add(user.email)

    if use_tls:
        smtp = smtplib.SMTP(host=server, port=port)
        smtp.ehlo()
        smtp.starttls()
    else:
        smtp = smtplib.SMTP(host=server, port=port)

    if settings.EMAIL_HOST_USER and settings.EMAIL_HOST_PASSWORD:
        smtp.login(settings.EMAIL_HOST_USER, settings.EMAIL_HOST_PASSWORD)

    smtp.sendmail(from_addr, to_addr, msg.as_string())
    smtp.close()


def send_test_mail(to_addr):
    subject = "Test Email from MediaViewer"
    text = "This is a test email generated by MediaViewer"

    sendMail(
        to_addr,
        subject,
        text,
    )


def checkSMTPServer():
    if not settings.BYPASS_SMTPD_CHECK:
        smtp_server = telnetlib.Telnet(  # nosec
            host=settings.EMAIL_HOST, port=settings.EMAIL_PORT
        )
        smtp_server.close()


def query_param_to_bool(param):
    if not param:
        return None
    elif param is True or param.lower() in ("true", "t", "y", "yes"):
        return True
    elif param is False or param.lower() in (
        "false",
        "f",
        "n",
        "no",
    ):
        return False
    else:
        raise ValueError(f'Could not coerce "{param}" to bool')
